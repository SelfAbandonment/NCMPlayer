# NCM Player æ„å»ºä¸è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ
# ä½œè€…: SelfAbandonment
#
# åŠŸèƒ½:
# - æ¯æ¬¡ push åˆ° main/master åˆ†æ”¯æ—¶è‡ªåŠ¨æ„å»ºï¼ˆä»…å½“ä»£ç æ–‡ä»¶å˜åŒ–æ—¶ï¼‰
# - è‡ªåŠ¨åˆ›å»ºå¸¦ç‰ˆæœ¬å·çš„ Release
# - ä¸Šä¼ æ„å»ºäº§ç‰©
#
# è·³è¿‡æ„å»º:
# - åœ¨ commit message ä¸­åŒ…å« [skip ci] æˆ– [ci skip] å¯è·³è¿‡æ„å»º
# - ä»…ä¿®æ”¹æ–‡æ¡£æˆ–é…ç½®æ–‡ä»¶ä¸ä¼šè§¦å‘æ„å»º

name: Build & Auto Release

on:
  push:
    branches: [ main, master ]
    paths:
      # ä»…å½“è¿™äº›æ–‡ä»¶å˜åŒ–æ—¶è§¦å‘æ„å»º
      - 'src/**'
      - 'build.gradle'
      - 'settings.gradle'
      - 'gradle.properties'
      - 'gradle/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'settings.gradle'
      - 'gradle.properties'
      - 'gradle/**'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆä¸å—è·¯å¾„é™åˆ¶ï¼‰

permissions:
  contents: write

jobs:
  build:
    name: Build with Gradle
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Generate Gradle Wrapper if missing
        run: |
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "Gradle wrapper jar missing, generating..."
            gradle wrapper --gradle-version=8.10
          fi

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build --no-daemon

      - name: Get version from gradle.properties
        id: get_version
        run: |
          VERSION=$(grep "mod_version" gradle.properties | cut -d'=' -f2 | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Mod version: $VERSION"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: NCM-Player-Mod
          path: build/libs/*.jar
          retention-days: 30

  release:
    name: Auto Release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: NCM-Player-Mod
          path: build/libs/

      - name: Get commit info
        id: commit_info
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version }}-${{ steps.commit_info.outputs.sha }}
          name: NCM Player v${{ needs.build.outputs.version }} (${{ steps.commit_info.outputs.sha }})
          body: |
            ## NCM Player v${{ needs.build.outputs.version }}
            
            **æäº¤ä¿¡æ¯:** ${{ steps.commit_info.outputs.message }}
            
            ### åŠŸèƒ½
            - ğŸµ åœ¨ Minecraft ä¸­æ’­æ”¾ç½‘æ˜“äº‘éŸ³ä¹
            - ğŸ” æ‰«ç ç™»å½•ç½‘æ˜“äº‘è´¦å·
            - ğŸ” æœç´¢æ­Œæ›²
            - â¯ æ’­æ”¾æ§åˆ¶
            
            ### å®‰è£…
            1. ä¸‹è½½ `ncmplayer-${{ needs.build.outputs.version }}.jar`
            2. æ”¾å…¥ `.minecraft/mods/` æ–‡ä»¶å¤¹
            3. éœ€è¦ NeoForge 1.21.1
            
            ### ä½¿ç”¨
            - æŒ‰ **M é”®** æ‰“å¼€éŸ³ä¹æ’­æ”¾å™¨
          files: build/libs/ncmplayer-*.jar
          draft: false
          prerelease: false
          fail_on_unmatched_files: false

